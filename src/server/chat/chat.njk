{% extends 'layouts/page.njk' %}

{% from "govuk/components/phase-banner/macro.njk" import govukPhaseBanner %}
{% from "govuk/components/button/macro.njk" import govukButton %}

{% block beforeContent %}
  {{ govukPhaseBanner({
    tag: { text: phaseTag },
    html: phaseTagText
  }) }}
{% endblock %}

{% block content %}
<div class="govuk-grid-row chat-container">
  <div class="govuk-grid-column-full">
    <a class="govuk-skip-link" href="#chat-log">Skip to conversation</a>
    <a class="govuk-skip-link" href="#question">Skip to quesion entry</a>
    <div class="chat-scroll-area">
        <div id="chat-log" aria-label="Chat history" role="log" aria-live="polite">
        {% if conversationHistory and conversationHistory.length > 0 %}
            {% for message in conversationHistory %}
              {% if message.role == 'assistant' %}
                <div class="chat-message ai">
                  <div class="chat-bubble ai">
                    <span class="govuk-visually-hidden">AI:</span>
                    <div class="govuk-body govuk-!-font-weight-bold">AI</div>
                    <div class="govuk-body">{{ message.content | safe }}</div>
                  </div>
                </div>

                {% if message.sources and message.sources.length > 0 %}
                    <div class="app-chat-sources">
                        <p class="govuk-!-font-weight-bold govuk-body-s">Sources for this answer:</p>
                        <ul class="govuk-list govuk-list--bullet">
                        {% for source in message.sources %}
                            <li><a class="govuk-link" href="{{ source.location }}" target="_blank" rel="noopener">{{ source.name }}</a></li>
                        {% endfor %}
                        </ul>
                    </div>
                {% endif %}
              {% endif %}
              {% if message.role == 'user' %}
                <div class="chat-message user">
                    <div class="chat-bubble user">
                    <span class="govuk-visually-hidden">User:</span>
                    <div class="govuk-body govuk-!-font-weight-bold">You</div>
                    <div class="govuk-body">{{ message.content | safe }}</div>
                    </div>
                </div>
              {% endif %}
            {% endfor %}
        {% else %}
            <p class="govuk-body">No chat history yet.</p>
        {% endif %}
        </div>
    </div>
    <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
    <div id="question-form">
      <form method="post" action="/" autocomplete="off">
      <input type="hidden" name="conversationId" value="{{ conversationId }}">
      <div id="question" class="govuk-form-group">
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                <input class="govuk-input" id="question" name="question" type="text" required />
            </div>
            <div class="govuk-grid-column-one-third">
                <div class="govuk-button-group">
                    <button class="govuk-button" data-module="govuk-button" type="submit">
                        Ask question
                    </button>
                </div>
            </div>
        </div>
        <a class="govuk-link" href="{{ transcriptUrl }}">Download transcript of this chat</a>
      </div>
      </form>
    </div>

    {% if tokenUsage and tokenUsage.length > 0 %}
      <h3 class="govuk-heading-m">Request Information</h3>
      <table class="govuk-table">
        <thead class="govuk-table__head">
          <tr class="govuk-table__row">
            <th scope="col" class="govuk-table__header">Stage</th>
            <th scope="col" class="govuk-table__header">Model</th>
            <th scope="col" class="govuk-table__header govuk-table__header--numeric">Input tokens</th>
            <th scope="col" class="govuk-table__header govuk-table__header--numeric">Output tokens</th>
            <th scope="col" class="govuk-table__header govuk-table__header--numeric">Total tokens</th>
          </tr>
        </thead>
        <tbody class="govuk-table__body">
          {% for usageItem in tokenUsage %}
          <tr class="govuk-table__row">
            <td class="govuk-table__cell">{{ usageItem.stageName }}</td>
            <td class="govuk-table__cell">{{ usageItem.model }}</td>
            <td class="govuk-table__cell govuk-table__cell--numeric">{{ usageItem.inputTokens or 0 }}</td>
            <td class="govuk-table__cell govuk-table__cell--numeric">{{ usageItem.outputTokens or 0 }}</td>
            <td class="govuk-table__cell govuk-table__cell--numeric">{{ usageItem.totalTokens or 0 }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </div>
</div>
{% endblock %}
