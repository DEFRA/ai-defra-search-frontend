{% extends 'layouts/page.njk' %}

{# Import GOVUK components #}
{% from "govuk/components/phase-banner/macro.njk" import govukPhaseBanner %}
{% from "govuk/components/textarea/macro.njk" import govukTextarea %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}
{% from "govuk/components/details/macro.njk" import govukDetails %}
{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}

{% block beforeContent %}
  {{ govukPhaseBanner({
    tag: {
      text: phaseTag
    },
    html: phaseTagText
  }) }}
{% endblock %}

{% block content %}
  {{ appHeading({
    text: heading,
    caption: "Debug tool for testing vector store functionality"
  }) }}

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      
      {% if error %}
        {{ govukErrorSummary({
          titleText: "There is a problem",
          errorList: [
            {
              text: error
            }
          ]
        }) }}
      {% endif %}

      {{ govukInsetText({
        html: 'This debug page allows you to test the vector store search functionality and setup operations. Use this tool to verify that the vector store is working correctly.'
      }) }}

      <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
          <h2 class="govuk-heading-l">Vector Store Search</h2>
          
          <form action="/debug/vectorstore" method="post" novalidate>
            {{ govukTextarea({
              name: "question",
              id: "question",
              value: question,
              label: {
                text: "Enter your question",
                classes: "govuk-label--m"
              },
              hint: {
                text: "Ask a question to test the vector store search functionality"
              },
              rows: 4
            }) }}
            
            {{ govukButton({
              text: "Search Vector Store",
              type: "submit"
            }) }}
          </form>

          <div class="govuk-!-margin-top-6">
            <h2 class="govuk-heading-l">Vector Store Setup</h2>
            <p class="govuk-body">Add URLs to populate the vector store with new content. Enter one URL per line.</p>
            
            <form action="/debug/setup" method="post" novalidate>
              {{ govukTextarea({
                name: "urls",
                id: "urls",
                value: urls,
                label: {
                  text: "URLs to add to vector store",
                  classes: "govuk-label--m"
                },
                hint: {
                  text: "Enter one URL per line. For example:\nhttps://www.gov.uk/example-page-1\nhttps://www.gov.uk/example-page-2"
                },
                rows: 6
              }) }}
              
              {{ govukButton({
                text: "Setup Vector Store",
                classes: "govuk-button--secondary",
                type: "submit"
              }) }}
            </form>
          </div>
        </div>
        
        <div class="govuk-grid-column-one-third">
          {% if results %}
            <h2 class="govuk-heading-l">Results</h2>
            
            <h3 class="govuk-heading-m">Response</h3>
            <p class="govuk-body"><strong>Status:</strong> {{ results.status }}</p>
            
            {% if results.retrieved_docs %}
              <h4 class="govuk-heading-s">Retrieved Documents</h4>
              {% for doc in results.retrieved_docs %}
                <div class="govuk-!-margin-bottom-4 debug-document">
                  <h5 class="govuk-heading-s">Document {{ loop.index }}</h5>
                  <p><strong>ID:</strong> {{ doc.id }}</p>
                  <p><strong>Title:</strong> {{ doc.metadata.title }}</p>
                  <p><strong>Source:</strong> {{ doc.metadata.source }}</p>
                  <p><strong>Language:</strong> {{ doc.metadata.language }}</p>
                  {{ govukDetails({
                    summaryText: "View content",
                    html: '<p class="govuk-body-s">' + doc.page_content + '</p>'
                  }) }}
                </div>
              {% endfor %}
            {% endif %}
            
            {% if results.docIds is defined %}
              <h4 class="govuk-heading-s">Setup Response</h4>
              <p><strong>Document IDs:</strong> {% if results.docIds.length > 0 %}{{ results.docIds | join(', ') }}{% else %}None{% endif %}</p>
            {% endif %}
            
            {{ govukDetails({
              summaryText: "View raw JSON response",
              html: '<pre class="debug-json">' + (results | dump(2)) + '</pre>'
            }) }}
          {% endif %}
          
          {% if error %}
            <h2 class="govuk-heading-l">Error</h2>
            <div class="govuk-error-message">{{ error }}</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
{% endblock %}