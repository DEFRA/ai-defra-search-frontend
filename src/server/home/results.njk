{% extends 'layouts/page.njk' %}

{# Import GOVUK components #}
{% from "govuk/components/phase-banner/macro.njk" import govukPhaseBanner %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}
{% from "govuk/components/details/macro.njk" import govukDetails %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}

{% block beforeContent %}
  {{ govukPhaseBanner({
    tag: {
      text: phaseTag
    },
    html: phaseTagText
  }) }}
{% endblock %}

{% block content %}
  {{ appHeading({
    text: heading,
    caption: "AI-powered search results for government guidance"
  }) }}

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      
      {# Display the question asked #}
      <div class="govuk-!-margin-bottom-6">
        <h2 class="govuk-heading-m">Your question</h2>
        {{ govukInsetText({
          text: question
        }) }}
      </div>

      {# Display the answer #}
      <div class="govuk-!-margin-bottom-8">
        <h2 class="govuk-heading-l">Answer</h2>
        <div class="answer-content">
          {{ answer | formatAnswer | safe }}
        </div>
      </div>

    </div>
  </div>

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      
      {# Source Documents #}
      {% if sourceDocuments and sourceDocuments.length > 0 %}
        <h2 class="govuk-heading-l">Sources</h2>
        <p class="govuk-body">This answer is based on the following government documents:</p>
        
        {% for doc in sourceDocuments %}
          {{ govukDetails({
            summaryText: "Source " + doc.index + ": " + doc.title,
            html: "
              <div class='govuk-body-s govuk-!-margin-bottom-3'>
                <strong>Source:</strong> " + doc.source + "<br>
                <strong>Document type:</strong> " + doc.type + "<br>
                <strong>Language:</strong> " + doc.language + "
              </div>
              <div class='govuk-body-s'>
                <strong>Relevant excerpt:</strong><br>
                <div style='background-color: #f3f2f1; padding: 15px; border-left: 5px solid #1d70b8; margin-top: 10px;'>" + doc.content + "</div>
              </div>
            "
          }) }}
        {% endfor %}
      {% endif %}

    </div>
    
    <div class="govuk-grid-column-one-third">
      
      <h3 class="govuk-heading-m">Request Information</h3>
      
      {% if usage %}
        <dl class="govuk-summary-list">
          
          {% if usage.models and usage.models.length > 0 %}
            {% for model in usage.models %}
              <div class="govuk-summary-list__row">
                <dt class="govuk-summary-list__key">AI Model {{ loop.index }}{% if usage.models.length > 1 %} of {{ usage.models.length }}{% endif %}</dt>
                <dd class="govuk-summary-list__value">{{ model.modelId }}</dd>
              </div>
              
              <div class="govuk-summary-list__row">
                <dt class="govuk-summary-list__key">Tokens</dt>
                <dd class="govuk-summary-list__value">
                  Input: {{ model.tokens.input or 0 }}<br>
                  Output: {{ model.tokens.output or 0 }}<br>
                  <strong>Total: {{ model.tokens.total or 0 }}</strong>
                </dd>
              </div>
              
            {% endfor %}
            
            {% if usage.models.length > 1 %}
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key"><strong>Total Tokens (All Models)</strong></dt>
              <dd class="govuk-summary-list__value">
                <strong>Input: {{ usage.totalTokens.input or 0 }}<br>
                Output: {{ usage.totalTokens.output or 0 }}<br>
                Total: {{ usage.totalTokens.total or 0 }}</strong>
              </dd>
            </div>
            {% endif %}
          {% else %}
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key">AI Model</dt>
              <dd class="govuk-summary-list__value">Not specified</dd>
            </div>
            
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key">Tokens used</dt>
              <dd class="govuk-summary-list__value">Input: 0<br>Output: 0<br><strong>Total: 0</strong></dd>
            </div>
          {% endif %}
          
          {% if usage.timestamp %}
          <div class="govuk-summary-list__row">
            <dt class="govuk-summary-list__key">Processed at</dt>
            <dd class="govuk-summary-list__value">
              {{ usage.timestamp.toLocaleString('en-GB', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              }) }}
            </dd>
          </div>
          {% endif %}
        </dl>
      {% else %}
        <p class="govuk-body-s">Usage information not available for this request.</p>
        {% if sessionId %}
        <dl class="govuk-summary-list">
          <div class="govuk-summary-list__row">
            <dt class="govuk-summary-list__key">Session ID</dt>
            <dd class="govuk-summary-list__value">{{ sessionId }}</dd>
          </div>
        </dl>
        {% endif %}
      {% endif %}

      <div class="govuk-!-margin-top-6">
        <h3 class="govuk-heading-s">Ask another question</h3>
        <p class="govuk-body-s">Want to search for more information?</p>
        {{ govukButton({
          text: "Ask another question",
          href: "/",
          classes: "govuk-button--secondary"
        }) }}
      </div>

      <div class="govuk-!-margin-top-6">
        <h3 class="govuk-heading-s">Feedback</h3>
        <p class="govuk-body-s">
          Was this answer helpful? 
          <a href="mailto:defra.ai.search@defra.gov.uk?subject=Feedback on AI Search Results&body=Session ID: {{ usage.sessionId if usage }}%0A%0AQuestion: {{ question }}%0A%0AFeedback:" class="govuk-link">
            Send us feedback
          </a>
        </p>
      </div>

    </div>
  </div>

{% endblock %}