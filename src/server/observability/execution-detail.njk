{% extends 'layouts/page.njk' %}

{# Import GOVUK components #}
{% from "govuk/components/phase-banner/macro.njk" import govukPhaseBanner %}
{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}
{% from "govuk/components/details/macro.njk" import govukDetails %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/tag/macro.njk" import govukTag %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}

{% block beforeContent %}
  {{ govukPhaseBanner({
    tag: {
      text: phaseTag
    },
    html: 'This is a new service â€“ your <a class="govuk-link" href="mailto:defra.ai.search@defra.gov.uk">feedback</a> will help us to improve it.'
  }) }}
  
  {{ govukBackLink({
    text: "Back to Observability Dashboard",
    href: "/observability"
  }) }}
{% endblock %}

{% block content %}
  {{ appHeading({
    text: heading,
    caption: "Execution ID: " + execution.basic.executionId
  }) }}

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      <p class="govuk-body-s govuk-!-margin-bottom-6">
        Last updated: <strong>{{ lastUpdated }}</strong>
      </p>
    </div>
  </div>

  {# Basic Execution Information #}
  <div class="govuk-grid-row govuk-!-margin-bottom-6">
    <div class="govuk-grid-column-two-thirds">
      <h2 class="govuk-heading-l">Execution Summary</h2>
      
      {{ govukSummaryList({
        rows: [
          {
            key: {
              text: "Status"
            },
            value: {
              html: govukTag({
                text: execution.basic.status.text,
                classes: execution.basic.status.class
              })
            }
          },
          {
            key: {
              text: "Timestamp"
            },
            value: {
              text: execution.basic.timestamp
            }
          },
          {
            key: {
              text: "Duration"
            },
            value: {
              text: execution.basic.duration
            }
          },
          {
            key: {
              text: "Start Time"
            },
            value: {
              text: execution.basic.startTime
            }
          },
          {
            key: {
              text: "End Time"
            },
            value: {
              text: execution.basic.endTime
            }
          },
          {
            key: {
              text: "Documents Retrieved"
            },
            value: {
              text: execution.documents.count
            }
          },
          {
            key: {
              text: "Input Validation"
            },
            value: {
              html: govukTag({
                text: "Passed" if execution.validation.input else "Failed",
                classes: "govuk-tag--green" if execution.validation.input else "govuk-tag--red"
              })
            }
          },
          {
            key: {
              text: "Output Validation"
            },
            value: {
              html: govukTag({
                text: "Passed" if execution.validation.output else "Failed",
                classes: "govuk-tag--green" if execution.validation.output else "govuk-tag--red"
              })
            }
          }
        ]
      }) }}
    </div>
  </div>

  {# User Query #}
  <div class="govuk-grid-row govuk-!-margin-bottom-6">
    <div class="govuk-grid-column-full">
      <h2 class="govuk-heading-l">User Query</h2>
      {{ govukInsetText({
        text: execution.basic.query
      }) }}
    </div>
  </div>

  {# Answer #}
  <div class="govuk-grid-row govuk-!-margin-bottom-6">
    <div class="govuk-grid-column-full">
      <h2 class="govuk-heading-l">Generated Answer</h2>
      <div class="govuk-body">
        {{ execution.answer | replace('\n', '<br>') | safe }}
      </div>
    </div>
  </div>

  {# Source Documents #}
  {% if execution.documents.count > 0 %}
  <div class="govuk-grid-row govuk-!-margin-bottom-6">
    <div class="govuk-grid-column-full">
      <h2 class="govuk-heading-l">Source Documents</h2>
      
      {% for doc in execution.documents.list %}
        {{ govukDetails({
          summaryText: doc.metadata.title or "Document " + loop.index,
          html: '<p class="govuk-body-s"><strong>Source:</strong> ' + doc.metadata.source + '</p>
                 <p class="govuk-body-s"><strong>Language:</strong> ' + doc.metadata.language + '</p>
                 <div class="govuk-body-s" style="max-height: 200px; overflow-y: auto; background: #f8f8f8; padding: 10px; margin-top: 10px;">
                   ' + doc.page_content + '
                 </div>'
        }) }}
      {% endfor %}
    </div>
  </div>
  {% endif %}

  {# Node Execution Details #}
  {% if execution.nodes | length > 0 %}
  <div class="govuk-grid-row govuk-!-margin-bottom-6">
    <div class="govuk-grid-column-full">
      <h2 class="govuk-heading-l">Node Execution Details</h2>
      
      {{ govukTable({
        head: [
          {
            text: "Node Name"
          },
          {
            text: "Type"
          },
          {
            text: "Status"
          },
          {
            text: "Timestamp"
          },
          {
            text: "Duration"
          },
          {
            text: "Input Size"
          },
          {
            text: "Output Size"
          }
        ],
        rows: execution.nodeTableRows
      }) }}
    </div>
  </div>
  {% endif %}

  {# Token Usage #}
  {% if execution.tokenUsage %}
  <div class="govuk-grid-row govuk-!-margin-bottom-6">
    <div class="govuk-grid-column-full">
      <h2 class="govuk-heading-l">Token Usage</h2>
      
      {% for modelName, usage in execution.tokenUsage %}
        <h3 class="govuk-heading-m">{{ modelName }}</h3>
        {{ govukSummaryList({
          rows: [
            {
              key: {
                text: "Input Tokens"
              },
              value: {
                text: usage.input_tokens
              }
            },
            {
              key: {
                text: "Output Tokens"
              },
              value: {
                text: usage.output_tokens
              }
            },
            {
              key: {
                text: "Total Tokens"
              },
              value: {
                text: usage.total_tokens
              }
            }
          ]
        }) }}
      {% endfor %}
    </div>
  </div>
  {% endif %}

  {# Error Information #}
  {% if execution.error %}
  <div class="govuk-grid-row govuk-!-margin-bottom-6">
    <div class="govuk-grid-column-full">
      <h2 class="govuk-heading-l">Error Details</h2>
      
      {{ govukSummaryList({
        rows: [
          {
            key: {
              text: "Error Message"
            },
            value: {
              text: execution.error.message
            }
          },
          {
            key: {
              text: "Error Type"
            },
            value: {
              text: execution.error.type
            }
          }
        ] + ([{
          key: {
            text: "Stack Trace"
          },
          value: {
            html: '<pre style="font-size: 12px; overflow: auto; max-height: 300px;">' + execution.error.stackTrace + '</pre>'
          }
        }] if execution.error.stackTrace else [])
      }) }}
    </div>
  </div>
  {% endif %}

{% endblock %}